#!/bin/bash

HOST="pkgbuild.com"

PKGEXT=".pkg.tar.xz"

usage() {
  echo "A simple script to get, sign and push the package's signature"
  echo
  echo "usage: getsignpkg <pkgbase> [pkg_dir]"
  echo
  echo "path is set to svn-packages as default"
  echo
}

getpkg() {
  rsync -e ssh -p --chmod=ug=rw,o=r -c -h -L --progress --partial -y ${HOST}:${1} "${DEST}"
}

signpkg() {
  gpg --detach-sign --use-agent ${1}
}

uplsign() {
  rsync -e ssh -p --chmod=ug=rw,o=r -c -h -L --progress --partial -y ${1} ${HOST}:"${2}"
}

main() {
  if [ $# -eq 0 ]; then
    usage
    exit 1
  fi

  DEST="$(mktemp -d --tmpdir)"
  cd "${DEST}"

  # By default the package folder structure on the host is something
  # like ~/svn-packages/pkgname/trunk/
  
  pkgbase="${1}"
  pkg_dir="svn-packages/${pkgbase}/trunk"
  
  [ -n "${2}" ] && pkg_dir="${2}"
  
  echo "Downloading packages into ${DEST}..."
  for pkg in `ssh ${HOST} ls "${pkg_dir}"/*${PKGEXT}`; do
    getpkg "${pkg}" || exit 1
  done

  echo "Signing packages..."
  for pkg in *$PKGEXT; do
    signpkg ${pkg} || exit 1
  done

  echo "Uploading signatures..."
  for pkg in *$PKGEXT.sig; do
    uplsign ${pkg} "${pkg_dir}" || exit 1
  done
}

main $@

exit 0
